### Performance gain by swapping register r13 and r14 of x86-64

* Introduction

We made a surprising observation that in a certain circumstance, by
simply swapping the registers r13 and r14 of x86-64, we gain 5~10%
speed up. We do not understand why this happens. We guess that it may
be a performance bug of the x86-64 architecture.

* Original Observation

- We generate `Queens.s`
  + from `Queens.c` in the LLVM Nightly Test 
    (`https://github.com/llvm-mirror/test-suite/blob/master/SingleSource/Benchmarks/Stanford/Queens.c`)
  + using Clang 4.0 RC 4 
    (`clang -O3 -S -o Queens.s Queens.c`).
- We generate `Queens.swap.s` by simply swapping `r13` and `r14` in `Queens.s`.
- We generate executables `Queens` and `Queens.swap` from the assemly files.
- We observe 5~10% speed up in `Queens.swp` compared to `Queens` on all our x86-64 machines.

* Simplifications made

- We made the following simplification from the original `Queens.c`.
  + We removed all system calls by removing all occurrences of `printf`.
  + We added a single line unused function `void foo() {}` before the main algorithm function `Try` in order to increase the size of the code section.
    This is misteriously needed to reproduce the speed up.

- Then, we follow the same steps as above.

- We generate `Queens.s`
  + from `Queens.c` in the LLVM Nightly Test 
    (`https://github.com/llvm-mirror/test-suite/blob/master/SingleSource/Benchmarks/Stanford/Queens.c`)
  + using Clang 4.0 RC 4 
    (`clang -O3 -S -o Queens.s Queens.c`).
- We generate `Queens.swap.s` by simply swapping `r13` and `r14` in `Queens.s`.
- We generate executables `Queens` and `Queens.swap` from the assemly files.
- We observe 5~10% speed up in `Queens.swp` compared to `Queens` on all our x86-64 machines.

* Effect of the code section size

- In order to show the effect of the code section size, we perfomed the same test after removing the code for the unused function `foo`.

- Int this case, we do not observe any speed up after swapping `r13` and `r14`.

* Instructions for test

- `Queens-org.c`: the original source code of the Queens benchmark.

- `Queens.c`: the modified code from `Queens-org.c` after removing `printf` and adding `foo`.

- `Queens.s`: The assembly code generated from `Queens.c`

- `Queens.elim.s` : The assmebly code generated from `Queens.s` by removing `foo`.

- Run `swap.sh` to generate `Queens.swap.s` and `Queens.elim.swap.s` from `Queens.s` and `Queens.elim.s` by swapping `r13` and `r14`

- Run `build-asm.sh` to generate the executables.

- Run `run.sh gcc` to observe the speed up (gcc is used as an assembler).
  The speed up is up to 10% in our experiment.

- Run `run.sh clang` to observe the speed up (clang is used an as assembler).
  The speed up is up to 5% in our experiment because the executable before register swapping is 5% faster compared to the executable generated by the gcc assembler.

- Run `run.sh gcc .elim` or `run.sh clang .elim` to observe that there is no speed up in the absence of `foo`.
 
